<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feature #387: State Transitions - UAT Gateway</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .state-machine-diagram {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .state {
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            text-align: center;
            min-width: 120px;
            transition: all 0.3s ease;
        }

        .state.pending {
            background: #ffeaa7;
            color: #d63031;
            border: 2px solid #fdcb6e;
        }

        .state.running {
            background: #74b9ff;
            color: #0984e3;
            border: 2px solid #0984e3;
        }

        .state.completed {
            background: #55efc4;
            color: #00b894;
            border: 2px solid #00b894;
        }

        .state.failed {
            background: #ff7675;
            color: #d63031;
            border: 2px solid #d63031;
        }

        .state.cancelled {
            background: #dfe6e9;
            color: #636e72;
            border: 2px solid #b2bec3;
        }

        .transitions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .transition-arrow {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 18px;
            color: #6c5ce7;
        }

        .demo-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .control-group h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 5px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #00b894;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #00a884;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 184, 148, 0.4);
        }

        .btn-danger {
            background: #d63031;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(214, 48, 49, 0.4);
        }

        .btn-warning {
            background: #fdcb6e;
            color: #2d3436;
        }

        .btn-warning:hover:not(:disabled) {
            background: #f39c12;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(253, 203, 110, 0.4);
        }

        .btn-info {
            background: #74b9ff;
            color: #0984e3;
        }

        .btn-info:hover:not(:disabled) {
            background: #0984e3;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4);
        }

        .journey-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .journey-card.status-pending {
            border-color: #fdcb6e;
            background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
        }

        .journey-card.status-running {
            border-color: #0984e3;
            background: linear-gradient(135deg, #e6f2ff 0%, #ffffff 100%);
        }

        .journey-card.status-completed {
            border-color: #00b894;
            background: linear-gradient(135deg, #e6fff9 0%, #ffffff 100%);
        }

        .journey-card.status-failed {
            border-color: #d63031;
            background: linear-gradient(135deg, #ffe6e6 0%, #ffffff 100%);
        }

        .journey-card.status-cancelled {
            border-color: #b2bec3;
            background: linear-gradient(135deg, #f0f0f0 0%, #ffffff 100%);
        }

        .journey-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .journey-name {
            font-size: 18px;
            font-weight: 600;
            color: #2d3436;
        }

        .journey-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .journey-status.pending {
            background: #ffeaa7;
            color: #d63031;
        }

        .journey-status.running {
            background: #74b9ff;
            color: #0984e3;
            animation: pulse 2s infinite;
        }

        .journey-status.completed {
            background: #55efc4;
            color: #00b894;
        }

        .journey-status.failed {
            background: #ff7675;
            color: #d63031;
        }

        .journey-status.cancelled {
            background: #dfe6e9;
            color: #636e72;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .journey-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #636e72;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 14px;
            color: #2d3436;
            font-weight: 500;
        }

        .log {
            background: #2d3436;
            color: #00b894;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 8px;
            padding-left: 15px;
            border-left: 3px solid #00b894;
        }

        .log-entry.error {
            border-left-color: #d63031;
            color: #ff7675;
        }

        .log-entry.success {
            border-left-color: #00b894;
            color: #55efc4;
        }

        .log-entry.info {
            border-left-color: #74b9ff;
            color: #74b9ff;
        }

        .valid-transitions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .valid-transition {
            padding: 8px 15px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 20px;
            font-size: 13px;
            color: #667eea;
            font-weight: 500;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 10px;
        }

        .badge.valid {
            background: #00b894;
            color: white;
        }

        .badge.invalid {
            background: #d63031;
            color: white;
        }

        .acceptance-criteria {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .acceptance-criteria h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .criteria-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .criteria-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .criteria-status.pass {
            background: #00b894;
            color: white;
        }

        .criteria-status.pending {
            background: #dfe6e9;
            color: #636e72;
        }

        .criteria-text {
            flex: 1;
            font-size: 14px;
        }
    </style>
    <link rel="stylesheet" href="feature440-contrast-fixes.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Feature #387: State Transitions Work Correctly</h1>
            <p>Comprehensive demonstration of journey state machine validation</p>
        </div>

        <div class="content">
            <!-- State Machine Diagram -->
            <div class="section">
                <h2>üéØ State Machine Overview</h2>
                <div class="state-machine-diagram">
                    <div class="state pending">PENDING</div>
                    <div class="state running">RUNNING</div>
                    <div class="state completed">COMPLETED</div>
                    <div class="state failed">FAILED</div>
                    <div class="state cancelled">CANCELLED</div>
                </div>
                <div class="transitions">
                    <div class="transition-arrow">‚Üí PENDING ‚Üí RUNNING</div>
                    <div class="transition-arrow">‚Üí RUNNING ‚Üí COMPLETED</div>
                    <div class="transition-arrow">‚Üí RUNNING ‚Üí FAILED</div>
                    <div class="transition-arrow">‚Üí (any) ‚Üí CANCELLED</div>
                    <div class="transition-arrow">‚Üí (terminal) ‚Üí PENDING (reset)</div>
                </div>
            </div>

            <!-- Demo Controls -->
            <div class="section">
                <h2>üéÆ Interactive Demo</h2>
                <div class="control-group">
                    <h3>Create New Journey</h3>
                    <button class="btn btn-primary" onclick="createNewJourney()">Create New Journey</button>
                </div>
            </div>

            <!-- Journey Card -->
            <div class="section">
                <h2>üìã Current Journey</h2>
                <div id="journeyCard" class="journey-card" style="display: none;">
                    <div class="journey-header">
                        <div class="journey-name" id="journeyName">-</div>
                        <div class="journey-status" id="journeyStatus">-</div>
                    </div>
                    <div class="demo-controls" id="actionButtons">
                        <!-- Buttons will be dynamically shown/hidden based on state -->
                        <div class="control-group">
                            <h3>State Transitions</h3>
                            <button class="btn btn-success" onclick="startJourney()" id="btnStart">‚ñ∂ Start</button>
                            <button class="btn btn-primary" onclick="completeJourney(true)" id="btnComplete">‚úì Complete (Success)</button>
                            <button class="btn btn-danger" onclick="completeJourney(false)" id="btnFail">‚úó Complete (Failure)</button>
                            <button class="btn btn-warning" onclick="cancelJourney()" id="btnCancel">‚èπ Cancel</button>
                            <button class="btn btn-info" onclick="resetJourney()" id="btnReset">‚Ü∫ Reset</button>
                        </div>
                        <div class="control-group">
                            <h3>Valid Transitions</h3>
                            <div class="valid-transitions" id="validTransitions">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                    </div>
                    <div class="journey-details">
                        <div class="detail-item">
                            <div class="detail-label">Journey ID</div>
                            <div class="detail-value" id="journeyId">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Created At</div>
                            <div class="detail-value" id="createdAt">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Started At</div>
                            <div class="detail-value" id="startedAt">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Completed At</div>
                            <div class="detail-value" id="completedAt">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Started By</div>
                            <div class="detail-value" id="startedBy">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Completion Summary</div>
                            <div class="detail-value" id="completionSummary">-</div>
                        </div>
                    </div>
                </div>
                <div id="noJourney" style="text-align: center; padding: 40px; color: #636e72;">
                    <p>No journey created yet. Click "Create New Journey" to begin.</p>
                </div>
            </div>

            <!-- Event Log -->
            <div class="section">
                <h2>üìú Event Log</h2>
                <div class="log" id="eventLog">
                    <div class="log-entry info">Waiting for actions...</div>
                </div>
            </div>

            <!-- Acceptance Criteria -->
            <div class="section">
                <h2>‚úÖ Acceptance Criteria</h2>
                <div class="acceptance-criteria">
                    <div class="criteria-item">
                        <div class="criteria-status pending" id="ac1Status">1</div>
                        <div class="criteria-text">AC1: Create journey in pending state - New journeys have status="pending"</div>
                    </div>
                    <div class="criteria-item">
                        <div class="criteria-status pending" id="ac2Status">2</div>
                        <div class="criteria-text">AC2: Start tests (transitions to running) - PENDING ‚Üí RUNNING works</div>
                    </div>
                    <div class="criteria-item">
                        <div class="criteria-status pending" id="ac3Status">3</div>
                        <div class="criteria-text">AC3: Complete tests (transitions to complete) - RUNNING ‚Üí COMPLETED/FAILED works</div>
                    </div>
                    <div class="criteria-item">
                        <div class="criteria-status pending" id="ac4Status">4</div>
                        <div class="criteria-text">AC4: Verify transitions are valid - All valid transitions work correctly</div>
                    </div>
                    <div class="criteria-item">
                        <div class="criteria-status pending" id="ac5Status">5</div>
                        <div class="criteria-text">AC5: Verify invalid transitions are blocked - Invalid transitions return 400 error</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8889';
        let currentJourney = null;
        let authToken = null;
        let csrfToken = null;
        let acMet = { ac1: false, ac2: false, ac3: false, ac4: false, ac5: false };

        // Initialize
        async function init() {
            await login();
        }

        // Login and get tokens
        async function login() {
            try {
                const response = await fetch(`${API_BASE}/auth/login?username=testuser&password=TestPass123!`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    log('Successfully logged in', 'success');
                } else {
                    // Try to register
                    const registerResponse = await fetch(`${API_BASE}/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: 'testuser',
                            email: 'testuser@example.com',
                            password: 'TestPass123!'
                        })
                    });

                    if (registerResponse.ok) {
                        // Try login again
                        const loginResponse = await fetch(`${API_BASE}/auth/login?username=testuser&password=TestPass123!`, {
                            method: 'POST'
                        });
                        const data = await loginResponse.json();
                        authToken = data.access_token;
                        log('Registered and logged in', 'success');
                    }
                }

                // Get CSRF token
                const csrfResponse = await fetch(`${API_BASE}/api/csrf-token`);
                const csrfData = await csrfResponse.json();
                csrfToken = csrfData.csrf_token;
            } catch (error) {
                log(`Login error: ${error.message}`, 'error');
            }
        }

        // Create new journey
        async function createNewJourney() {
            try {
                const journeyName = `TEST_387_DEMO_${Date.now().toString(36)}`;

                const response = await fetch(`${API_BASE}/api/journeys`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        name: journeyName,
                        description: 'Demo journey for Feature #387 state transitions',
                        priority: 5,
                        steps: ['step1', 'step2', 'step3'],
                        scenarios: []
                    })
                });

                if (response.ok) {
                    currentJourney = await response.json();
                    log(`Created journey: ${currentJourney.name} (status: ${currentJourney.status})`, 'success');
                    updateUI();
                    markACMet('ac1');
                } else {
                    const error = await response.json();
                    log(`Failed to create journey: ${error.error || error.message}`, 'error');
                }
            } catch (error) {
                log(`Create error: ${error.message}`, 'error');
            }
        }

        // Start journey
        async function startJourney() {
            if (!currentJourney) return;

            try {
                const response = await fetch(`${API_BASE}/api/journeys/${currentJourney.id}/start`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'X-CSRF-Token': csrfToken
                    }
                });

                if (response.ok) {
                    currentJourney = await response.json();
                    log(`Started journey: ${currentJourney.name} (status: ${currentJourney.status})`, 'success');
                    updateUI();
                    markACMet('ac2');
                    markACMet('ac4');
                } else {
                    const error = await response.json();
                    log(`Failed to start: ${error.error}`, 'error');
                    if (response.status === 400 && error.error_code === 'invalid_state_transition') {
                        markACMet('ac5');
                    }
                }
            } catch (error) {
                log(`Start error: ${error.message}`, 'error');
            }
        }

        // Complete journey
        async function completeJourney(success) {
            if (!currentJourney) return;

            try {
                const response = await fetch(`${API_BASE}/api/journeys/${currentJourney.id}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`,
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify({
                        success: success,
                        summary: success ? 'All tests passed' : 'Some tests failed'
                    })
                });

                if (response.ok) {
                    currentJourney = await response.json();
                    const status = success ? 'COMPLETED' : 'FAILED';
                    log(`Completed journey: ${currentJourney.name} (status: ${currentJourney.status})`, success ? 'success' : 'error');
                    updateUI();
                    markACMet('ac3');
                    markACMet('ac4');
                } else {
                    const error = await response.json();
                    log(`Failed to complete: ${error.error}`, 'error');
                    if (response.status === 400 && error.error_code === 'invalid_state_transition') {
                        markACMet('ac5');
                    }
                }
            } catch (error) {
                log(`Complete error: ${error.message}`, 'error');
            }
        }

        // Cancel journey
        async function cancelJourney() {
            if (!currentJourney) return;

            try {
                const response = await fetch(`${API_BASE}/api/journeys/${currentJourney.id}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'X-CSRF-Token': csrfToken
                    }
                });

                if (response.ok) {
                    currentJourney = await response.json();
                    log(`Cancelled journey: ${currentJourney.name} (status: ${currentJourney.status})`, 'info');
                    updateUI();
                    markACMet('ac4');
                } else {
                    const error = await response.json();
                    log(`Failed to cancel: ${error.error}`, 'error');
                }
            } catch (error) {
                log(`Cancel error: ${error.message}`, 'error');
            }
        }

        // Reset journey
        async function resetJourney() {
            if (!currentJourney) return;

            try {
                const response = await fetch(`${API_BASE}/api/journeys/${currentJourney.id}/reset`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'X-CSRF-Token': csrfToken
                    }
                });

                if (response.ok) {
                    currentJourney = await response.json();
                    log(`Reset journey: ${currentJourney.name} (status: ${currentJourney.status})`, 'info');
                    updateUI();
                    markACMet('ac4');
                } else {
                    const error = await response.json();
                    log(`Failed to reset: ${error.error}`, 'error');
                }
            } catch (error) {
                log(`Reset error: ${error.message}`, 'error');
            }
        }

        // Get valid transitions
        async function getValidTransitions() {
            if (!currentJourney) return [];

            try {
                const response = await fetch(`${API_BASE}/api/journeys/${currentJourney.id}/valid-transitions`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    return data.valid_transitions || [];
                }
            } catch (error) {
                log(`Error getting valid transitions: ${error.message}`, 'error');
            }
            return [];
        }

        // Update UI
        async function updateUI() {
            if (!currentJourney) {
                document.getElementById('journeyCard').style.display = 'none';
                document.getElementById('noJourney').style.display = 'block';
                return;
            }

            document.getElementById('journeyCard').style.display = 'block';
            document.getElementById('noJourney').style.display = 'none';

            // Update journey card
            document.getElementById('journeyName').textContent = currentJourney.name;
            document.getElementById('journeyStatus').textContent = currentJourney.status;
            document.getElementById('journeyId').textContent = currentJourney.id;
            document.getElementById('createdAt').textContent = currentJourney.created_at || '-';
            document.getElementById('startedAt').textContent = currentJourney.started_at || '-';
            document.getElementById('completedAt').textContent = currentJourney.completed_at || '-';
            document.getElementById('startedBy').textContent = currentJourney.started_by || '-';
            document.getElementById('completionSummary').textContent = currentJourney.completion_summary || '-';

            // Update card styling
            const card = document.getElementById('journeyCard');
            card.className = `journey-card status-${currentJourney.status}`;

            // Update buttons based on valid transitions
            const validTransitions = await getValidTransitions();
            const canStart = validTransitions.includes('running');
            const canComplete = validTransitions.includes('completed') || validTransitions.includes('failed');
            const canCancel = validTransitions.includes('cancelled');
            const canReset = validTransitions.includes('pending') && currentJourney.status !== 'pending';

            document.getElementById('btnStart').disabled = !canStart;
            document.getElementById('btnComplete').disabled = !canComplete;
            document.getElementById('btnFail').disabled = !canComplete;
            document.getElementById('btnCancel').disabled = !canCancel;
            document.getElementById('btnReset').disabled = !canReset;

            // Update valid transitions display
            const validTransitionsDiv = document.getElementById('validTransitions');
            validTransitionsDiv.innerHTML = validTransitions.map(t =>
                `<div class="valid-transition">${t.toUpperCase()}</div>`
            ).join('');
        }

        // Log event
        function log(message, type = 'info') {
            const logDiv = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.insertBefore(entry, logDiv.firstChild);
        }

        // Mark acceptance criteria as met
        function markACMet(ac) {
            if (!acMet[ac]) {
                acMet[ac] = true;
                const statusEl = document.getElementById(`${ac}Status`);
                statusEl.className = 'criteria-status pass';
                statusEl.textContent = '‚úì';
                log(`Acceptance criteria ${ac.toUpperCase()} verified!`, 'success');
            }
        }

        // Start
        init();
    </script>
</body>
</html>
